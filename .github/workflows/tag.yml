---
on:
  workflow_call:
    inputs:
      ACT_TESTING:
        required: true
        type: string
      API_DOC_S3_BUCKET:
        required: true
        type: string
      CLOUDFRONT_DISTRIBUTION_API:
        required: false
        type: string
      CLOUDFRONT_DISTRIBUTION_STATICS:
        required: false
        type: string
      BUILD_PATH:
        required: true
        type: string
      ENVIRONMENT:
        required: true
        type: string
      NODE_VERSION:
        required: true
        type: string
      AWS_REGION:
        required: true
        type: string
      TESTING_REPO:
        required: true
        type: string

    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_ACCOUNT_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
      PRIVATE_REPO_ACCESS:
        required: true

name: Statics Tag

jobs:
  tag:
    name: tag
    runs-on: ubuntu-latest
    environment: ${{ inputs.ENVIRONMENT }}
    steps:
      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y%m%d')"

      - name: Checkout branch "production"
        uses: actions/checkout@v2
        with:
          ref: production

      - name: Get last succesfull deploy on STA
        uses: nrwl/last-successful-commit-action@v1
        id: last_successful_commit
        with:
          branch: main
          workflow_id: sandbox-staging.yml
          github_token: ${{ secrets.PRIVATE_REPO_ACCESS }}

      - name: Tag snapshot
        uses: tvdias/github-tagger@v0.0.1
        with:
          repo-token: ${{ secrets.PRIVATE_REPO_ACCESS }}
          tag: ${{ steps.date.outputs.date }}-${{ steps.last_successful_commit.outputs.commit_hash }}
