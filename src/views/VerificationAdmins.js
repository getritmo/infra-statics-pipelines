import React from 'react'
import { Container } from 'reactstrap'
import Breadcrumb from '../components/Breadcrumb'
import Loading from '../components/Loading'
import { withAuthenticationRequired } from '@auth0/auth0-react'
import { useSelector } from 'react-redux'
import Validator from '../components/Validator'
import SVGInline from 'react-svg-inline'
import StatusIcon from '../components/StatusIcon'
import { decode, inArray } from '../utils/userFunctions'
import translate from '../i18n/translate'
import { CustomButton } from 'components/UI'
import useAPI from 'hooks/useAPI'

export const VerificationAdmins = () => {
  const storeStatus = useSelector((state) => state.appData)
  const storeStatusApplication = storeStatus ? storeStatus.application : false

  const { apiFileDownload } = useAPI()

  const submitContinue = (e) => {
    e.preventDefault()
    e.stopPropagation()

    const url = '/direct-debit'
    document
      .querySelector('.menu-column__section a[href="' + url + '"]')
      .click()
  }

  let kycAccepted = false
  let kycPrepared = false
  let previousStepsDone = false

  const download = async (item) => {
    const url = `/uploads/${item.id}`
    await apiFileDownload(url, 'GET', item.name)
  }

  if (storeStatus) {
    kycAccepted = storeStatusApplication.kyc.is_accepted
    kycPrepared =
      storeStatus.application.kyc &&
      storeStatus.application.kyc.files.length > 0

    if (
      inArray(decode(storeStatusApplication.status), 3) &&
      inArray(decode(storeStatusApplication.status), 4) &&
      inArray(decode(storeStatusApplication.status), 5) &&
      inArray(decode(storeStatusApplication.status), 6) &&
      inArray(decode(storeStatusApplication.status), 7) &&
      inArray(decode(storeStatusApplication.status), 8)
    ) {
      previousStepsDone = true
    }
  }

  return (
    <>
      <Container className="">
        <>
          <Breadcrumb
            previous={translate(
              'views.verification_admins.breadcrumb.previous',
            )}
            actual={translate('views.verification_admins.breadcrumb.current')}
          />

          <>
            <h1 className="layout-app__title">
              <SVGInline
                className="image-icon"
                svg={
                  '<svg width="47px" height="48px" viewBox="0 0 47 48" version="1.1" xmlns="http://www.w3.org/2000/svg" className="image-icon"><defs><linearGradient x1="100%" y1="99.9958334%" x2="5.43323864%" y2="-5.30638844%" id="linearGradient-1"><stop stop-color="#000000" offset="0%"></stop><stop stop-color="#000000" offset="100%"></stop></linearGradient></defs><path d="M39.5813253,22.112453 L43.7349503,26.2680363 C45.3995336,27.9326196 46.3160336,30.1474946 46.3160336,32.499453 C46.3160336,34.8533696 45.3995336,37.0682446 43.7349503,38.7308696 L41.3497003,41.1161196 C39.6812003,42.786578 37.4134503,43.697203 35.1006586,43.697203 C34.3799919,43.697203 33.6534503,43.609078 32.9386586,43.426953 L26.1119086,41.6859946 C25.8573253,41.6213696 25.6399503,41.4568696 25.5067836,41.2316613 C25.0407003,40.4326613 24.5589503,38.521328 26.0766586,37.0036196 C26.7503253,36.329953 27.6589919,36.0675363 28.5441586,36.0087863 L20.1918669,27.6564946 C19.6376586,27.1022863 19.3321586,26.3639946 19.3321586,25.578703 C19.3321586,24.7934113 19.6376586,24.057078 20.1918669,23.5009113 C21.3355336,22.3552863 23.2018253,22.3552863 24.3454919,23.5009113 L26.5429386,25.6991144 C26.6826314,25.4052746 26.8738297,25.1301152 27.1165336,24.8874113 C28.0686094,23.928792 29.5290243,23.7709433 30.6530749,24.4138651 C30.7944761,24.0826373 31.001283,23.7717453 31.2721169,23.5009113 C32.2269032,22.5444902 33.6853366,22.386534 34.8064809,23.0270428 C34.9501972,22.6903097 35.1598871,22.3802662 35.4277003,22.112453 C36.5713669,20.9687863 38.4337419,20.9687863 39.5813253,22.112453 Z M36.8122419,23.4969946 C36.6262003,23.6830363 36.5243669,23.927828 36.5243669,24.1902446 C36.5243669,24.4089252 36.5964445,24.6153662 36.727,24.7846351 L36.8641586,24.939703 L38.1948253,26.2699946 C38.5767003,26.6518696 38.5767003,27.2726613 38.1948253,27.6545363 C38.0048669,27.8444946 37.7542003,27.940453 37.5035336,27.940453 C37.2528669,27.940453 37.0022003,27.8444946 36.8102836,27.6545363 L34.0412003,24.885453 C33.6593253,24.503578 33.0385336,24.503578 32.6566586,24.885453 C32.3041586,25.237953 32.2770432,25.7940269 32.5753125,26.177846 L32.6711586,26.286703 L35.4257419,29.0410363 C35.8076169,29.4229113 35.8076169,30.043703 35.4257419,30.425578 C35.2357836,30.613578 34.9851169,30.7095363 34.7344503,30.7095363 C34.4837836,30.7095363 34.2331169,30.613578 34.0412003,30.4236196 L29.8875753,26.2699946 C29.5057003,25.8861613 28.8829503,25.890078 28.5010753,26.2699946 C28.1224292,26.6505925 28.1211629,27.2685115 28.4972762,27.6526355 L32.6547003,31.8101196 C33.0365753,32.1919946 33.0365753,32.8127863 32.6547003,33.1946613 C32.2728253,33.5765363 31.6520336,33.5765363 31.2701586,33.1946613 L22.9609503,24.885453 C22.5790753,24.5055363 21.9582836,24.503578 21.5764086,24.885453 C21.1945336,25.267328 21.1945336,25.8881196 21.5764086,26.2699946 L31.9634086,36.6550363 C32.2845753,36.976203 32.3413669,37.4736196 32.1044086,37.8594113 C31.8654919,38.245203 31.3974503,38.4175363 30.9627003,38.2765363 C30.1284503,38.0004113 28.1740336,37.6674946 27.4612003,38.386203 C26.9128669,38.9345363 26.9579086,39.5416196 27.0617003,39.9058696 L33.4243253,41.529328 C35.7449503,42.1246613 38.2614086,41.4372863 39.9632003,39.7335363 L42.3484503,37.3482863 C43.6448669,36.0518696 44.3577003,34.3304946 44.3577003,32.499453 C44.3577003,30.6684113 43.6448669,28.9489946 42.3504086,27.652578 L38.1967836,23.4969946 C37.8149086,23.117078 37.1941169,23.1151196 36.8122419,23.4969946 Z M18.4803402,25.655646 C19.0971615,26.7900454 17.7023816,28.1903326 17.4471451,28.2861381 C15.3723822,29.0649209 14.1823221,30.920425 14.1823221,33.5708139 L14.1823221,34.2060637 C14.1823221,34.8135925 13.4232615,35.699103 12.2940724,35.699103 C11.1648834,35.699103 10.4497597,34.8135925 10.4497597,34.2060637 L10.4497597,33.5708139 C10.4497597,29.7134765 12.7718427,26.3878972 16.0914415,24.9186433 C16.3557208,24.8016733 17.863519,24.5212466 18.4803402,25.655646 Z M15.3308249,0.699103008 C15.6556395,0.699103008 15.9410955,0.902879234 16.0507866,1.20073533 L16.0806534,1.30335465 L16.5097426,3.27716501 C16.9038581,3.40589174 17.2906996,3.55765266 17.6677875,3.73137318 L18.0415323,3.91237375 L19.7412349,2.81966578 C20.0111845,2.64620141 20.3562168,2.66083094 20.6087245,2.84539 L20.6987504,2.92252962 L22.5911573,4.81558691 C21.5829354,4.95910758 20.6262145,5.26448801 19.7482253,5.70449774 L19.3772179,5.33367575 L17.9706922,6.23794656 C17.7546572,6.37672521 17.479575,6.38468066 17.2559382,6.25845402 C16.6720072,5.9289211 16.0495366,5.67081051 15.4058513,5.49137068 C15.1940087,5.43227295 15.0250282,5.27680049 14.9466704,5.0756085 L14.9152645,4.97143706 L14.5602741,3.33844586 L11.7528799,3.33844586 L11.3978895,4.97143706 C11.343262,5.22229926 11.1544524,5.42242332 10.9073027,5.49137068 C10.2636174,5.67081051 9.64114674,5.9289211 9.05703904,6.25845402 C8.86550183,6.36664828 8.63603816,6.37638966 8.43834066,6.28945941 L8.34246175,6.23794656 L6.93575929,5.33367575 L4.95060635,7.31900546 L5.85487716,8.72553115 C5.99383259,8.94156616 6.00161126,9.21664836 5.87538462,9.44028522 C5.54585171,10.0242161 5.28774112,10.6466868 5.10830128,11.2903721 C5.04920355,11.5022147 4.89373109,11.6711952 4.6925391,11.749553 L4.58836766,11.7809589 L2.95537646,12.1359493 L2.95537646,14.9433435 L4.58854443,15.2983339 C4.83940663,15.3529614 5.03935392,15.541771 5.10830128,15.7889207 C5.28791794,16.432606 5.54602848,17.0550766 5.8755614,17.6390076 C5.98375566,17.8306963 5.99336716,18.0601816 5.9063998,18.2578822 L5.85487716,18.3537616 L4.95078313,19.7602873 L6.93593607,21.745617 L8.34246175,20.8413462 C8.55849676,20.7025676 8.83357896,20.6946121 9.05721582,20.8208388 C9.64114674,21.1503717 10.2636174,21.4084823 10.9073027,21.5879221 C11.1191453,21.6470198 11.2881258,21.8024923 11.3664836,22.0036843 L11.3978895,22.1078557 L11.7528799,23.7408469 L13.4851808,23.7405069 C12.3755491,24.4064288 11.3946112,25.2698674 10.604131,26.2794652 C10.449841,26.1928611 10.3277141,26.0532567 10.2637161,25.882185 L10.2325006,25.7759381 L9.80341144,23.8021278 C9.40929593,23.6734011 9.02245437,23.5216401 8.64536652,23.3479196 L8.27162174,23.166919 L6.57191906,24.259627 C6.30196951,24.4330914 5.95693718,24.4184618 5.70442949,24.2339028 L5.61440355,24.1567632 L2.53946022,21.0818198 C2.3127026,20.8550622 2.25360395,20.5148289 2.38032867,20.2287276 L2.43659638,20.1243043 L3.52930435,18.4246017 C3.34106352,18.0542918 3.17442406,17.6734016 3.0304606,17.284411 L2.89409561,16.892812 L0.920285254,16.4637228 C0.602876802,16.3945983 0.367359731,16.13487 0.323430402,15.8205157 L0.316033609,15.7138943 L0.316033609,11.3653985 C0.316033609,11.0405838 0.519809835,10.7552866 0.817665926,10.6454844 L0.920285254,10.61557 L2.89409561,10.1864808 C3.02282234,9.79236533 3.17458326,9.40552377 3.34830378,9.02843592 L3.52930435,8.65469114 L2.43659638,6.95498846 C2.26313201,6.68503891 2.27776155,6.34000658 2.4623206,6.08749889 L2.53946022,5.99747295 L5.61440355,2.92252962 C5.84116122,2.695772 6.18139445,2.63667335 6.46749583,2.76339807 L6.57191906,2.81966578 L8.27162174,3.91237375 C8.6419316,3.72413292 9.02282174,3.55749346 9.41181242,3.41353 L9.80341144,3.27716501 L10.2325006,1.30335465 C10.3014488,0.985946201 10.5613181,0.75042913 10.8757024,0.706499801 L10.9823291,0.699103008 L15.3308249,0.699103008 Z M17.4431871,20.7507566 C18.0718799,21.3573228 18.785379,21.8765459 19.5639494,22.288691 L18.8244718,22.2455439 C17.3759539,22.2455439 15.9743845,22.5566884 14.6959251,23.115648 L14.9152645,22.1078557 C14.969892,21.8569935 15.1587016,21.6568695 15.4058513,21.5879221 C16.0495366,21.4084823 16.6720072,21.1503717 17.2561149,20.8208388 L17.3547214,20.7749378 L17.4431871,20.7507566 Z M24.2992554,6.31979171 C28.6907816,6.31979171 32.2621315,9.89114163 32.2621315,14.2826678 C32.2621315,18.674194 28.6907816,22.2455439 24.2992554,22.2455439 C19.9077292,22.2455439 16.3363793,18.674194 16.3363793,14.2826678 C16.3363793,9.89114163 19.9077292,6.31979171 24.2992554,6.31979171 Z M13.156577,7.40073182 C14.3857425,7.40073182 15.531715,7.76388732 16.4928314,8.38853516 C16.1817006,8.79368579 15.9033047,9.22461301 15.6611482,9.67771314 C14.9404678,9.20863178 14.0798119,8.93546045 13.156577,8.93546045 C10.6178972,8.93546045 8.55239105,11.0009666 8.55239105,13.5396464 C8.55239105,16.0783262 10.6178972,18.1438323 13.156577,18.1438323 C13.9168339,18.1438323 14.6346558,17.9585938 15.2672772,17.6308819 C15.4642793,18.1060725 15.6991435,18.5623345 15.9683707,18.9950874 C15.1262069,19.4318708 14.1696483,19.678561 13.156577,19.678561 C9.77167057,19.678561 7.01766242,16.9245528 7.01766242,13.5396464 C7.01766242,10.15474 9.77167057,7.40073182 13.156577,7.40073182 Z M24.2992554,9.68994707 C21.7659107,9.68994707 19.7065347,11.749323 19.7065347,14.2826678 C19.7065347,16.8160125 21.7659107,18.8753885 24.2992554,18.8753885 C26.8326002,18.8753885 28.8919761,16.8160125 28.8919761,14.2826678 C28.8919761,11.749323 26.8326002,9.68994707 24.2992554,9.68994707 Z" fill="url(#linearGradient-1)" fill-rule="nonzero"></path></svg>'
                }
              />
              <span>{translate('views.verification_admins.text1')}</span>
            </h1>
          </>

          {storeStatus && (
            <section className="accounts__section">
              <div className="layout-app__info">
                {/* Estado inicial */}
                {!previousStepsDone && (
                  <>
                    <h2 className="layout-app__title--h2">
                      <div className="alert">
                        <StatusIcon status="alert" />
                        {translate('views.verification_admins.text2')}
                      </div>
                    </h2>

                    <p>{translate('views.verification_admins.text3')}</p>

                    <Validator status={storeStatusApplication} actual={9} />
                  </>
                )}

                {/* Una vez aceptada  la kyc */}
                {previousStepsDone && !kycPrepared && (
                  <>
                    <h2 className="layout-app__title--h2">
                      <div className="pending">
                        <StatusIcon status="pending" />
                        {translate('views.verification_admins.text4')}
                      </div>
                    </h2>
                    <p>{translate('views.verification_admins.text5')}</p>
                  </>
                )}

                {/* Estado tras verificación propiedad */}
                {previousStepsDone && kycPrepared && kycAccepted && (
                  <>
                    <h2 className="layout-app__title--h2">
                      <div className="accepted">
                        <StatusIcon status="accepted" />
                        {translate('views.verification_admins.text6')}
                      </div>
                    </h2>
                    <p>{translate('views.verification_admins.text7')}</p>
                  </>
                )}

                {storeStatus && (
                  <div className="layout-app__file--container">
                    {storeStatus.application.kyc.files.map((j) => {
                      return (
                        <button
                          key={j}
                          className="layout-app__file"
                          onClick={() => {
                            download(j)
                          }}
                        >
                          <div
                            className={
                              'layout-app__file--item kyc-file ' + j.format
                            }
                          />
                          <div className="layout-app__file--name">
                            <span>{j.name}</span>
                          </div>
                        </button>
                      )
                    })}
                  </div>
                )}
              </div>
            </section>
          )}
        </>
      </Container>

      <div className="company-details__submit">
        <CustomButton
          onClick={submitContinue}
          label={translate('views.verification_admins.text8')}
        />
      </div>
    </>
  )
}

export default withAuthenticationRequired(VerificationAdmins, {
  loginOptions: {
    language: document.cookie.indexOf('locale=es') === -1 ? 'en' : 'es',
  },
  Redirecting: () => <Loading />,
})
